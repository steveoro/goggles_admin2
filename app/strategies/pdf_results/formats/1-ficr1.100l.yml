#
# = Layout format definition for PdfResults::FormatParser
#
# Spawn of 1-ficr1.100m, it's a "long misaligned spread" version, where 100+m results are rendered
# on a 4 text row output per result row like this:
#
# ---8<---
# Pos. Nominativo                                 Crs. Naz.           50 m           100 m                                Arrivo    Pti Cat
#       Società                                        Anno                                                               Master    Pti SC
#
#                                                                                            A20 Under Femmine
#
#                                                                     31.50         1:05.94                               1:05.94
#    1 ROSPETTI ROMEA                               2    ITA
#                                                                                    34.44
#       MISTICANZA ASD                                  2001
#
# ---8<---
#
# Note that there's also an older version of this kind of layout that does not yield the
# team name so it's unprocessable (becase we need the team name to create the MIR row).
#
1-ficr1.100l:
  - name: header
    # Index is page-relative:
    at_fixed_row: 0
    # Repeat (at_fixed_row, each page)
    repeat: true
    rows:
      # "header" row #0
      - fields:
        - name: edition
          lambda: strip
          format: "\\s*(\\d{1,2}).{1,2}\\s+"
        - name: meeting_name
          lambda: strip
          format: "(?>\\s*[°^*oa']?)\\s+([\"“`']?.+[\"“`'\\b]?)"

      # "header" row #1
      - fields:
        - name: meeting_place
          lambda: strip
          # Support long place names like "Centro Federale di Ostia" or "Reggio nell'Emilia"
          format: "\\s*((\\w{1,}['\\s]?)+),\\s*"
        - name: meeting_date
          lambda: strip
          # Support month names too: dd(-/)mm(-/)yy(yy), dd MMM(...) yy(yy)
          format: "\\s*(\\d{2}([-\/]\\d{2}[-\/]\\d{2,4}|\\s\\w{3,}\\s\\d{2,4}))\\b"

      # Optional empty row #3
      - name: hdr_separator
        required: false
        format: "^$"

  - name: event
    # Repeat each page
    repeat: true
    parent: header
    rows:
      - fields:
        - name: event_length
          lambda: strip
          format: "\\s*(\\d{2,4})m?\\s+"
        - name: event_type
          lambda: strip
          format: "\\s*(?>m\\s)?((\\w+\\s?){1,2})\\sMaster\\sMisti\\b"

      - fields:
        - name: event_sub_hdr
          lambda: strip
          format: "Riepilogo|Serie\\s\\d{2}"

  # Data columns header
  - name: results_hdr
    repeat: true
    rows:
      - name: results_hdr1
        format: "\\s?Pos.\\s+Nominativo\\s+Crs.?\\s+Naz.?\\s+50 m\\s+100 m(?>\\s+150 m)?(?>\\s+200 m)?\\s+Arrivo\\s+Pti?\\s+Cat"
      - name: results_hdr2
        format: "\\s?Società\\s+Anno\\s+(FINA|Master)\\s+Pti?\\s+S.?C.?"

  # Optional row before category
  - name: cat_spacer
    parent: results_hdr
    required: false
    format: "^$"

  - name: category
    repeat: true
    parent: event
    rows:
      # Another optional empty row (in older files)
      - name: cat_spacer2
        required: false
        format: "^$"

      - name: cat_title
        format: "\\s*([UAM]\\d{2}\\s(Under|Master)\\s(Femmine|Maschi)(\\s(\\d{2}\\s-\\s\\d{2}))?)[\\b\\n]?"
      # Optional empty row
      - name: cat_separator1
        required: false
        format: "^$"

  - name: results
    repeat: true
    parent: category
    rows:
      - name: results0
        # DSQ results usually won't have the lap row with the timings:
        required: false
        fields:
          - name: spacer
            format: "^\\s{64,}"
            pop_out: false
          - name: lap50
            format: "\\s*(\\d{1,2}?[':.]?\\d{1,2}[\":.]\\d{1,2})\\s*\\b"
            pop_out: false
            token_start: 68
            token_end: 81
            required: false
          - name: lap100
            format: "\\s*(\\d{1,2}?[':.]?\\d{1,2}[\":.]\\d{1,2})\\s*\\b"
            pop_out: false
            token_start: 81
            token_end: 94
            required: false
          - name: lap150
            format: "\\s*(\\d{1,2}?[':.]?\\d{1,2}[\":.]\\d{1,2})\\s*\\b"
            pop_out: false
            token_start: 95
            token_end: 108
            required: false
          - name: lap200
            format: "\\s*(\\d{1,2}?[':.]?\\d{1,2}[\":.]\\d{1,2})\\s*\\b"
            pop_out: false
            token_start: 109
            token_end: 118
            required: false
          - name: timing
            format: "\\s*(\\d{1,2}?[':.]?\\d{1,2}[\":.]\\d{1,2})\\s*\\b"
            token_start: 119
            pop_out: false
            required: false

      - name: results1
        fields:
          - name: rank
            format: "\\s?(\\d{1,2}|SQ|RT|NP)\\s+"
            pop_out: false
          - name: swimmer_name
            format: "\\s+(\\D+(['`\\-\\.\\s]\\s?\\D+){1,4})\\s+"
            pop_out: false
            token_end: 31
          - name: lane_num
            format: "\\s*(\\d{1,2})\\s*"
            pop_out: false
            # Column alignment may vary (swimmer_name range can overlap safely with this due to its format):
            token_start: 25
            token_end: 52
          - name: nation
            format: "\\s*(\\w{2,3})\\b"
            pop_out: false
            token_start: 53
            token_end: 62

      - name: results2
        # ""RT" or "Retired" result rows usually won't even have the disqualify row:
        required: false
        fields:
          - name: spacer
            format: "\\s{80,}"
            pop_out: false
          - name: delta100
            format: "\\s*\\((\\d{1,2}?[':.]?\\d{1,2}[\":.]\\d{1,2})\\)\\s*"
            pop_out: false
            token_start: 83
            token_end: 94
            required: false
          - name: delta150
            format: "\\s*\\((\\d{1,2}?[':.]?\\d{1,2}[\":.]\\d{1,2})\\)\\s*"
            pop_out: false
            token_start: 96
            token_end: 107
            required: false
          - name: delta200
            format: "\\s*\\((\\d{1,2}?[':.]?\\d{1,2}[\":.]\\d{1,2})\\)\\s*"
            pop_out: false
            token_start: 109
            token_end: 120
            required: false
          - name: disqualify_type
            format: "^(?!\\s+(Orario Ufficializzazione|\\d{1,2}|www.ficr.it|corsie|Pagina))\\s+(\\D+\\s?)+\\b"
            token_start: 115
            required: false

      - name: results3
        fields:
          - name: team_name
            format: "^\\s{3,8}(([\\w\\d\\-&%'`]+.\\s?)+)"
            token_end: 43
            pop_out: false
          - name: year_of_birth
            format: "\\s*(\\d{4})\\b"
            pop_out: false
            token_start: 51
            token_end: 64

      - name: results4
        # This will match any empty row if the fields are not found:
        optional_if_empty: true
        # This will make the row not to fail if missing at all
        # => row #5 can be there, or be empty (no fields at all), or have either 1 or 2 matching fields
        required: false
        fields:
          - name: spacer
            format: "\\s{120,}"
            pop_out: false
          - name: std_score
            format: "\\s*(\\d?[,.]?\\d{1,4}[,.]\\d{1,2})\\b"
            token_start: 121
            pop_out: false
            # U25 / A20 do not score:
            required: false

  - name: disqualified
    parent: results
    required: false
    lambda: strip
    format: "\\s*Non Classificati\\b"

  - name: empty_row
    parent: event
    required: false
    format: "^$"

  - name: publish_time
    parent: event
    required: false
    lambda: strip
    format: "Orario Ufficializzazione"

  # End-Of-Page context
  - name: footer
    # Choose a link with the wrapping parent context from which the scan may resume
    # when after this, independently from check success or failure:
    parent: event
    # The 'eop' key implies that this context will be searched <row_span> lines before the end of page.
    # This also implies that the file must also be parsed in pages, otherwise the recognition will fail.
    # (DO NOT use eop: true when extracting the whole file, unless when processing batches of pages)
    eop: true
    row_span: 6
    repeat: true
    starts_with: Elaborazione dati a cura della Federazione Italiana Cronometristi -
    fields:
      - name: pool_type
        format: "\\s*www.ficr.it\\s+(\\d{1,2} corsie \\d{2}m)\\s+Pagina\\s*"
      # Actual last-line context marker
      - name: page_delimiter
        format: "\\s*Risultati su https://nuoto.ficr.it\\b"
