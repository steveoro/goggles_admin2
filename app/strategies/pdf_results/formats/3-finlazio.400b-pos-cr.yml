#
# = Layout format definition for PdfResults::FormatParser
#
# - FIN Lazio, 400m-only, w/ lap timings & deltas for each 50m, usually NO SCORES;
# - Meeting name on top on event change, meeting place on EOP.
# - NO 'event series' number
#
# - Uses a 'POS' + 'CR' double leading column format
# - Supports 'ANNO' + 'NAZ' columns, with both correct ('Anno' + 'Naz') OR inverted values ('Naz' & 'Anno', same header).
# - 'NAZ' column value stores the actual Nation code (3 letters, no numbers).
#
# Additionally, this format supports also a standard category & gender display in between each age range
# (as an optional context).
#
3-finlazio.400b-pos-cr:
  - name: header
    at_fixed_row: 0
    # Doesn't repeat always on each page:
    required: false
    # Sometimes the header w/ the meeting title will be repeated, in between events:
    repeat: true
    rows:
      - name: hdr_title
        fields:
          - name: edition
            required: false
            format: "^\\s{20,}(\\d{1,2}|[IVXLCM]+)\\D?\\D?\\s+"
            pop_out: false
          - name: meeting_name
            format: "^\\s{20,}(?>\\d{1,2}|[IVXLCM]+)?\\D?\\D?\\s+(.+)$"
            pop_out: false
      - name: hdr_pool
        fields:
          - name: pool_type
            lambda: strip
            format: "\\s*V\\.\\s(\\d{2})m"
      - name: hdr_sep
        format: "^$"
      - name: hdr_results
        # Using a custom non-existent field name in keys array to skip completely this row
        # from being part of the resulting context key:
        keys: [skip_me]
        format: "^\\s{20,}Risultati$"

  # Data columns header
  - name: results_hdr
    repeat: true
    rows:
      - name: results_hdr1
        format: "^\\s?POS\\s{1,}CR\\s{1,}COGNOME\\sE\\sNOME\\s{10,}ANNO\\s{1,}NAZ\\s{2,}(?>50\\sm)?\\s{3,}(?>100\\sm)?\\s{3,}(?>150\\sm)?\\s{3,}(?>200\\sm)?\\s{3,}(?>250\\sm)?\\s{3,}(?>300\\sm)?\\s{3,}(?>350\\sm)?\\s{3,}ARRIVO\\s{1,}(?>PUNTI|Record)"
      # Whenever the event is not repeated on page start, at least 2x empty rows take its place:
      - name: results_hdr_sep1
        required: false
        format: "^$"
      - name: results_hdr2
        format: "^\\s{6,}SOCIETA'"
      - name: results_hdr_sep2
        format: "^$"
      - name: results_hdr_sep3
        required: false
        format: "^$"
      - name: results_hdr_sep4
        required: false
        format: "^$"
      - name: results_hdr_sep5
        required: false
        format: "^$"

  - name: event
    # Repeats only in between events, so this is not required on each page:
    required: false
    repeat: true
    starts_at_row: 6
    parent: header
    rows:
      - fields:
        - name: event_length
          format: "^\\s{20,}(400)\\s?m\\s+"
          pop_out: false
        - name: event_type
          format: "^\\s{20,}400\\s?m\\s+(Stile(?>\\sLibero)?|Dorso|Rana|Delfino|Farfalla|Misti)\\s[-–]\\s"
          pop_out: false
        # No actual category title here, but the overall gender is displayed:
        - name: gender_type
          format: "\\s[-–]\\s(?>Master\\s|Under\\s|Propaganda\\s)?\\s?(Maschi|Femmine|Donne|Uomini)"
          required: false
          pop_out: false
      - name: event_sep0
        format: "^$"

  - name: category
    repeat: true
    # May lack whenever a category is reported on the next page:
    required: false
    starts_at_row: 4
    parent: event
    rows:
      - name: cat_sep0
        required: false
        format: "^$"
      - fields:
        - name: cat_title
          format: "^\\s{45,}((?>MASTER\\s|UNDER\\s|PROPAGANDA\\s)?\\d{2})\\s?(?>[MF]|DONNE|UOMINI)?"
          pop_out: false
        - name: gender_type
          format: "^\\s{45,}(?>MASTER\\s|UNDER\\s|PROPAGANDA\\s)?\\d{2}\\s?([MF]|DONNE|UOMINI)"
          pop_out: false
      - name: cat_sep1
        required: false
        format: "^$"
      - name: cat_sep2
        required: false
        format: "^$"

  # Actual data starts here:
  - name: results
    repeat: true
    parent: category
    starts_at_row: 4
    rows:
      - name: results_sep
        required: false
        format: "^$"

      - name: results_detail
        fields:
          - name: rank
            format: "^\\s{0,10}(\\d{1,3})\\s{1,8}\\d{1,2}\\s{1,3}\\w+"
            required: false
            pop_out: false
          - name: lane_num
            format: "^\\s{0,10}\\d{0,3}\\s{1,8}(\\d{1,2})\\s{1,3}\\w+"
            pop_out: false
          - name: swimmer_name
            format: "^\\s{0,10}\\d{0,3}\\s{1,8}\\d{1,2}\\s{1,3}((?>[a-zA-Z\\.'`àèéìòù]{1,16}[\\-\\s]?){1,8})\\s{2,}\\d{4}\\s{3,}(?>[a-zA-Z]{3})?\\s{3,}"
            pop_out: false
          - name: year_of_birth
            format: "^\\s{0,10}\\d{0,3}\\s{1,8}\\d{1,2}\\s{1,3}(?>[a-zA-Z\\.'`àèéìòù]{1,16}[\\-\\s]?){1,8}\\s{2,}(\\d{4})\\s{3,}(?>[a-zA-Z]{3})?\\s{3,}"
            pop_out: false
          - name: nation
            format: "^\\s{0,10}\\d{0,3}\\s{1,8}\\d{1,2}\\s{1,3}(?>[a-zA-Z\\.'`àèéìòù]{1,16}[\\-\\s]?){1,8}\\s{2,}\\d{4}\\s{3,}([a-zA-Z]{3})\\s{3,}"
            # Sometimes the 3 letter nation code may be missing:
            required: false
            pop_out: false

          - name: lap50
            format: "\\s+((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){7}(?>\\s{1,}\\d?[,.]?\\d{1,4}[,.]\\d{1,2})?$"
            pop_out: false
            required: false
          - name: lap100
            format: "\\s+((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){6}(?>\\s{1,}\\d?[,.]?\\d{1,4}[,.]\\d{1,2})?$"
            pop_out: false
            required: false
          - name: lap150
            format: "\\s+((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){5}(?>\\s{1,}\\d?[,.]?\\d{1,4}[,.]\\d{1,2})?$"
            pop_out: false
            required: false
          - name: lap200
            format: "\\s+((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){4}(?>\\s{1,}\\d?[,.]?\\d{1,4}[,.]\\d{1,2})?$"
            pop_out: false
            required: false
          - name: lap250
            format: "\\s+((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){3}(?>\\s{1,}\\d?[,.]?\\d{1,4}[,.]\\d{1,2})?$"
            pop_out: false
            required: false
          - name: lap300
            format: "\\s+((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){2}(?>\\s{1,}\\d?[,.]?\\d{1,4}[,.]\\d{1,2})?$"
            pop_out: false
            required: false
          - name: lap350
            format: "\\s+((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){1}(?>\\s{1,}\\d?[,.]?\\d{1,4}[,.]\\d{1,2})?$"
            pop_out: false
            required: false

          - name: timing
            format: "(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){7}\\s+((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s{1,}\\d?[,.]?\\d{1,4}[,.]\\d{1,2})?$"
            pop_out: false
            # DSQ don't have timings:
            required: false
          - name: disqualify_type
            format: "\\s+(ASS|SQ|RT|RIT|NP)\\b"
            token_start: 45
            pop_out: false
            required: false
          - name: std_score
            format: "\\s{2,}(?>\\d{1,2}[':\\.])?\\d{1,2}[\":\\.]\\d{1,2}\\s{1,}(\\d?[,.]?\\d{1,4}[,.]\\d{1,2})$"
            token_start: 45
            pop_out: false
            # U25 / A20 do not score:
            required: false

      - name: result_deltas
        fields:
          - name: team_name
            format: "^\\s{9,15}(.{3,29})(?>\\s{2,}|$)"
            # Sometimes team name is MISSING (ex. "Reg. Piemonte"):
            required: false
            pop_out: false

          # NOTE: using a mixed approach for ID'ing columns because sometimes delta100 have been found missing
          - name: delta100
            # ID the column from the left:
            format: "^.{40,}\\s{20,}((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})\\s+"
            pop_out: false
            required: false
          - name: delta150
            # ID all remaining columns from the right (EOLN):
            format: "((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){5}$"
            pop_out: false
            required: false
          - name: delta200
            format: "((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){4}$"
            pop_out: false
            required: false
          - name: delta250
            format: "((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){3}$"
            pop_out: false
            required: false
          - name: delta300
            format: "((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){2}$"
            pop_out: false
            required: false
          - name: delta350
            format: "((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})(?>\\s+(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}){1}$"
            pop_out: false
            required: false
          - name: delta400
            format: "(?>(?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2}\\s+){5}((?>\\d{1,2}[':\\.])?\\d{2}[\":\\.]\\d{2})$"
            pop_out: false
            required: false

  - name: disqualified
    parent: event
    required: false
    rows:
      - name: dsq_spacer1
        format: "^$"
      - name: dsq_title
        format: "^\\s{3,}NON\\sCLASSIFICATI|FUORI\\sGARA"
      - name: dsq_spacer2
        required: false
        format: "^$"

  # DSQ results have swimmer & team on a single row:
  - name: results_alt
    alternative_of: results
    required: false
    repeat: true
    parent: category
    rows:
      - name: results_detail
        fields:
          - name: rank
            # DSQ will have rank 0:
            format: "^\\s{0,10}(\\d{1,3})\\s{1,10}\\w+"
            pop_out: false
          - name: lane_num
            format: "^\\s{0,10}\\d{0,3}\\s{1,8}(\\d{1,2})\\s{1,3}\\w+"
            pop_out: false
          - name: swimmer_name
            format: "^\\s{0,10}\\d{0,3}\\s{1,8}\\d{1,2}\\s{1,3}((?>[a-zA-Z\\.'`àèéìòù]{1,16}[\\-\\s]?){1,8})\\s{2,}\\d{4}\\s{3,}(?>[a-zA-Z]{3})?\\s{2,}"
            pop_out: false
          - name: year_of_birth
            format: "^\\s{0,10}\\d{0,3}\\s{1,8}\\d{1,2}\\s{1,3}(?>[a-zA-Z\\.'`àèéìòù]{1,16}[\\-\\s]?){1,8}\\s{2,}(\\d{4})\\s{3,}(?>[a-zA-Z]{3})?\\s{2,}"
            pop_out: false
          - name: nation
            format: "^\\s{0,10}\\d{0,3}\\s{1,8}\\d{1,2}\\s{1,3}(?>[a-zA-Z\\.'`àèéìòù]{1,16}[\\-\\s]?){1,8}\\s{2,}\\d{4}\\s{3,}([a-zA-Z]{3})\\s{2,}"
            # Sometimes the 3 letter nation code may be missing:
            required: false
            pop_out: false
          - name: team_name
            format: "\\s{2,}\\d{4}\\s{2,}[a-zA-Z]{3}?\\s{2,}(.{3,29})(?>\\s{2,}|$)"
            token_start: 34
            # Sometimes team name is MISSING (ex. "Reg. Piemonte"):
            required: false
            pop_out: false
          # This qualifier must be present on the row for a true DSQ result:
          - name: dsq_flag
            format: "\\s{2,}\\d{4}\\s{2,}(?>[a-zA-Z]{3})?\\s{2}(?>.{3,29})(?>\\s{2,}(ASS|SQ|RT|RIT|NP))?$"
            token_start: 34
            pop_out: false

  - name: dsq_label
    parent: results_alt
    required: false
    rows:
      - name: dsq_spacer1
        required: false
        format: "^$"
      - name: dsq_type
        fields:
          - name: disqualify_type
            format: "^\\s{15,}(falsa\\spartenz\\w+|arrivo\\sirr.*|virata\\s.+|nuotata\\s.*)"
            pop_out: false
      - name: dsq_spacer2
        required: false
        format: "^$"

  - name: publish_time
    parent: event
    repeat: true
    required: false
    # Variable span: 2..3 rows
    rows:
      - name: publish_time1
        required: false
        format: "^$"
      - name: publish_time2
        keys: [skip_me]
        format: "^\\s+Pubblicata:"
      - name: publish_time3
        required: false
        format: "^$"
      - name: publish_time4
        required: false
        format: "^$"
      - name: publish_time5
        required: false
        format: "^$"

  # End-Of-Page, variable span:
  - name: footer
    parent: header
    eop: true
    repeat: true
    rows:
      - name: footer_spacer1
        format: "^$"
      - name: footer_spacer2
        required: false
        format: "^$"
      - name: footer_spacer3
        required: false
        format: "^$"
      - name: footer_spacer4
        required: false
        format: "^$"

      - name: footer_place
        fields:
          # Expected format: "<city>[,|/]\\s?<venue>"
          - name: meeting_place
            # Support long place names like "Centro Federale di Ostia (RM)" or "Reggio nell'Emilia"
            format: "^(.+)\\s?[,\\|/]\\s?.+$"
            pop_out: false
            # format: "^(.+)[,/]\\s?(?>\\w{2,}\\s?){1,}"
          - name: meeting_venue_or_date
            format: "^.+\\s?[,\\|/]\\s?(.+)$"
            pop_out: false
      - name: footer_page
        # Original:
        # format: "\\s{7,}Page\\s\\d{1,}"
        format: "^(\\s{70,}|\\s{30,}Elaborazione dati a cura della FEDERAZIONE ITALIANA NUOTO\\s{10,})Page\\s\\d{1,}"

      - name: footer_timestamp
        required: false
        format: "^\\s{50,}Stampata\\sil\\s\\d{1,2}"
