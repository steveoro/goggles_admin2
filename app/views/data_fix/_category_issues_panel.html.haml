:ruby
  panel_id = "category-issues-#{File.basename(file_path.to_s, File.extname(file_path.to_s)).parameterize}"
  collapse_id = "#{panel_id}-collapse"
  items = Array(summary)
  totals = { missing_gender: 0, missing_year: 0, category_unresolved: 0 }
  items.each do |row|
    issues = row['issues'] || row[:issues] || {}
    totals[:missing_gender] += 1 if issues['missing_gender'] || issues[:missing_gender]
    totals[:missing_year] += 1 if issues['missing_year'] || issues[:missing_year]
    totals[:category_unresolved] += 1 if issues['category_unresolved'] || issues[:category_unresolved]
  end

.card.border-warning.mb-3
  .card-header{id: "#{panel_id}-header"}
    %h5.mb-0.d-flex.align-items-center
      %button.btn.btn-link.p-0.text-left{ type: 'button', 'data-toggle' => 'collapse', 'data-target' => "##{collapse_id}", 'aria-expanded' => 'true', 'aria-controls' => collapse_id }
        %i.fa.fa-tag.mr-2
        Phase 3: Missing category data
        %span.badge.badge-pill.badge-warning.ml-2= items.size
  %div{ id: "#{collapse_id}", class: "collapse show", 'aria-labelledby' => "#{panel_id}-header" }
    .card-body
      %p.text-muted
        Some swimmers have badges without a resolved category_type. These usually require fixing missing year of birth or gender in Step 3, or enriching data from other results for this meeting.

      - unless totals.values.all?(&:zero?)
        .mb-2
          %strong Totals:
          - if totals[:missing_year] > 0
            %span.badge.badge-danger.ml-2
              = "Missing year of birth: #{totals[:missing_year]}"
          - if totals[:missing_gender] > 0
            %span.badge.badge-danger.ml-2
              = "Missing gender: #{totals[:missing_gender]}"
          - if totals[:category_unresolved] > 0
            %span.badge.badge-warning.ml-2
              = "Category not found despite available data: #{totals[:category_unresolved]}"

      %table.table.table-sm.table-striped.mt-3
        %thead
          %tr
            %th Swimmer key
            %th Team key
            %th Swimmer ID
            %th Team ID
            %th Issues
        %tbody
          - items.each do |row|
            - issues = row['issues'] || row[:issues] || {}
            %tr
              %td= row['swimmer_key']
              %td= row['team_key']
              %td= row['swimmer_id'] || '—'
              %td= row['team_id'] || '—'
              %td
                - if issues[:missing_year] || issues['missing_year']
                  %span.badge.badge-danger.mr-1 Missing year of birth
                - if issues[:missing_gender] || issues['missing_gender']
                  %span.badge.badge-danger.mr-1 Missing gender
                - if issues[:category_unresolved] || issues['category_unresolved']
                  %span.badge.badge-warning.mr-1 Category not found
