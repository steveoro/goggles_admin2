-# frozen_string_literal: true

:ruby
  # Displays a collapsible card for relay results grouped by MeetingProgram
  #
  # == Params:
  # - program_key: String, e.g., "1-4X50SL-100-119-X"
  # - relay_results: Array of DataImportMeetingRelayResult
  # - swimmers_by_id: Hash of Swimmer by ID
  # - teams_by_id: Hash of Team by ID
  # - teams_by_key: Hash of Team data by key (from phase 2)
  # - relay_swimmers_by_parent_key: Hash of DataImportMeetingRelaySwimmer arrays
  # - relay_laps_by_parent_key: Hash of DataImportRelayLap arrays
  # - card_index: Integer, for unique IDs
  parts = program_key.split('-')
  session_order = parts[0]
  event_code = parts[1]
  category = parts[2]
  gender = parts[3]
  # Split results: non-DSQ first (sorted by rank), then DSQ (natural order)
  non_dsq_results = relay_results.reject(&:disqualified?).sort_by(&:rank)
  dsq_results = relay_results.select(&:disqualified?)
  sorted_results = non_dsq_results + dsq_results
  program_id = relay_results.first&.meeting_program_id
  has_match = program_id.present?
  
  # Check if any results have issues (missing swimmer data)
  results_with_issues = []
  total_issue_count = 0
  sorted_results.each do |mrr|
    issue_info = relay_result_has_issues?(
      mrr,
      relay_swimmers_by_key: relay_swimmers_by_parent_key,
      swimmers_by_id: swimmers_by_id,
      swimmers_by_key: swimmers_by_key
    )
    if issue_info[:has_issues]
      results_with_issues << mrr.import_key
      total_issue_count += issue_info[:issue_count]
    end
  end
  has_issues = results_with_issues.any?
  
  # Border color: red for issues, green for matched, yellow for new
  border_color = if has_issues
                   'border-danger'
                 elsif has_match
                   'border-success'
                 else
                   'border-warning'
                 end
  border_width = 'border-2'

.card.mb-2{ class: "#{border_color} #{border_width}", id: "relay-program-card-#{card_index}", data: { has_issues: has_issues } }
  .card-header.d-flex.justify-content-between.align-items-center{ id: "relay-program-header-#{card_index}", style: 'cursor: pointer;', data: { toggle: 'collapse', target: "#relay-program-panel-#{card_index}" } }
    .d-flex.align-items-center
      %span.mr-2
        - if has_match
          %i.fa.fa-check-circle.text-success{ title: 'Matched MeetingProgram' }
        - else
          %i.fa.fa-plus-circle.text-warning{ title: 'New MeetingProgram' }
      %i.fa.fa-users.mr-2
      %strong
        = "#{event_code} • #{category} • #{gender}"
      &nbsp;
      %small.ml-2.text-muted
        Session #{session_order}
      - if has_match
        %small.ml-2.badge.badge-success
          ID: #{program_id}
      - else
        %small.ml-2.badge.badge-primary
          NEW
    .d-flex.align-items-center
      %span.badge.badge-info
        = "#{sorted_results.size} relay results"
      - if has_issues
        %span.badge.badge-danger.ml-2
          %i.fa.fa-exclamation-triangle
          = "#{total_issue_count} missing data"

  .collapse{ class: (has_issues ? 'show' : ''), id: "relay-program-panel-#{card_index}", 'aria-labelledby' => "relay-program-header-#{card_index}" }
    .card-body.p-0
      - sorted_results.each_with_index do |mrr, idx|
        :ruby
          team = teams_by_id[mrr.team_id]
          team_data = teams_by_key[mrr.import_key.split('/')[1]] if teams_by_key && team.nil?
          is_matched = team.present?
          relay_swimmers = relay_swimmers_by_parent_key[mrr.import_key] || []
          relay_laps = relay_laps_by_parent_key[mrr.import_key] || []
          has_laps = relay_laps.any?
          result_id = "relay-result-#{card_index}-#{idx}"
          bg_color = is_matched ? 'bg-light' : 'bg-warning-subtle'
          
          # Check if this result has missing swimmer data issues
          result_has_issues = relay_swimmers.any? do |rs|
            if rs.swimmer_id
              swimmer = swimmers_by_id[rs.swimmer_id]
              swimmer && (swimmer.gender_type_id.nil? || swimmer.year_of_birth.nil?)
            else
              # Unmatched swimmer - check phase3 data
              rs.swimmer_key && swimmer_has_missing_data?(rs.swimmer_key, swimmers_by_key: swimmers_by_key).values.any?
            end
          end
        
        .border-bottom{ class: bg_color, style: (result_has_issues ? 'border-left: 4px solid #dc3545 !important;' : '') }
          -# Main result row
          .p-3
            .d-flex.justify-content-between.align-items-start
              .d-flex.align-items-center
                - if mrr.disqualified?
                  %span.mr-3.text-muted{ style: 'font-size: 1.2em;' } -
                - else
                  %strong.mr-3{ style: 'font-size: 1.2em;' }
                    #{mrr.rank}º
                .d-flex.flex-column
                  %div
                    - if team
                      %strong= team.name
                      %small.ml-2.badge.badge-success
                        ID: #{team.id}
                    - elsif team_data
                      %strong= team_data['name']
                      %small.ml-2.badge.badge-warning
                        Unmatched
                    - else
                      %em.text-muted No team
                    -# Expand button for swimmers/laps
                    - if relay_swimmers.any? || relay_laps.any?
                      %button.btn.btn-sm.btn-outline-secondary.mt-2{ type: 'button', data: { toggle: 'collapse', target: "##{result_id}-details" } }
                        %i.fa.fa-chevron-down.mr-1
                        #{relay_swimmers.size} s, #{relay_laps.size} laps
                  - if team&.city
                    %small.text-muted= team.city.name

              .text-right
                - if mrr.disqualified?
                  %span.badge.badge-danger.ml-2{ style: 'font-size: 1.2em;' } DSQ
                - else
                  %h5.mb-0
                    = mrr.to_timing.to_s

          -# Collapsible details section (auto-expand if issues detected)
          .collapse{ class: (result_has_issues ? 'show' : ''), id: "#{result_id}-details" }
            .p-3.bg-white
              -# Unified Relay Swimmers Table (merged with lap data)
              - if relay_swimmers.any? || relay_laps.any?
                .table-responsive
                  %table.table.table-sm.table-bordered
                    %thead.thead-light
                      %tr
                        %th.text-center{ style: 'width: 60px;' } Order
                        %th.text-center{ style: 'width: 80px;' } Distance
                        %th Swimmer
                        %th.text-right{ style: 'width: 90px;' } From Start
                        %th.text-right{ style: 'width: 80px;' } Split
                        %th.text-center{ style: 'width: 100px;' } Status
                    %tbody
                      - relay_laps.sort_by(&:length_in_meters).each_with_index do |lap, idx|
                        :ruby
                          relay_order = idx + 1
                          # Find MRS for this lap by relay_order
                          mrs = relay_swimmers.find { |rs| rs.relay_order == relay_order }
                          swimmer = swimmers_by_id[mrs&.swimmer_id] if mrs
                          
                          # Timing values
                          delta_timing = Timing.new(minutes: lap.minutes, seconds: lap.seconds, hundredths: lap.hundredths)
                          from_start_timing = Timing.new(minutes: lap.minutes_from_start, seconds: lap.seconds_from_start, hundredths: lap.hundredths_from_start)
                          
                          # Match status
                          mrs_match_id = mrs&.meeting_relay_swimmer_id
                          lap_match_id = lap&.relay_lap_id

                          # Lookup unmatched swimmer name from source data
                          swimmer_info = relay_swimmer_names&.dig(mrr.import_key, relay_order)
                          swimmer_name_from_source = swimmer_info&.dig('name')
                          swimmer_key_from_source = swimmer_info&.dig('key')
                        %tr
                          %td.text-center
                            %strong= relay_order
                          %td.text-center= "#{lap.length_in_meters}m"
                          %td
                            - if swimmer
                              = swimmer.complete_name
                              - if swimmer.id
                                %small.ml-2.badge.badge-success
                                  ID: #{swimmer.id}
                            - elsif mrs&.swimmer_id
                              %em.text-muted Swimmer ##{mrs.swimmer_id}
                            - elsif swimmer_name_from_source.present?
                              = swimmer_name_from_source
                              %small.ml-2.badge.badge-warning Unmatched
                            - elsif mrs&.swimmer_key.present?
                              -# Has swimmer_key but no swimmer_id - show key and explain
                              %span.text-secondary= mrs.swimmer_key
                              %small.ml-2.badge.badge-warning{ title: 'Swimmer key present but not matched to DB' } Unmatched
                            - else
                              -# Truly missing - no swimmer info at all
                              %span.text-muted
                                = lap&.data_import_meeting_relay_swimmer&.try(:swimmer_key) || 'N/A'
                              %small.ml-2.badge.badge-danger{ title: 'No swimmer key found in source data' } NO SWIMMER KEY
                          %td.text-right
                            = from_start_timing.to_s
                          %td.text-right
                            = delta_timing.to_s
                          %td.text-center
                            - if mrs_match_id
                              %small.text-secondary
                                ID: #{mrs_match_id}
                            - elsif lap_match_id
                              %small.text-secondary
                                ID: #{lap_match_id}
                            - else
                              %small.badge.badge-primary NEW
