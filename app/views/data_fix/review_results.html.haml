-# frozen_string_literal: true

= render(partial: 'data_fix_legacy/modal_progress')

.container-fluid{ data: { controller: 'collapse-all', collapse_all_selector_value: '[id^="program-panel-"], [id^="relay-program-panel-"]' } }
  %h2 Data-Fix V2 • Step 5: Results (Phase 5)

  .mb-2
    = render(partial: 'data_fix/step_tabs', locals: { active_step: 5, file_path: @file_path })

  .d-flex.justify-content-between.my-2
    = link_to '< Back to file list', pull_result_files_path, class: 'btn btn-outline-secondary mr-2'
    - if @all_results.present? || @has_relay_results
      %div
        = button_to commit_phase6_path(file_path: @file_path),
                                       method: :post, class: 'btn btn-success',
                                       disabled: @issue_count.to_i.positive?,
                                       data: { confirm: I18n.t('data_import.data_fix.btn_start_sql_batch_confirm') } do
          %i.fa.fa-database
          = I18n.t('data_import.data_fix.btn_start_sql_batch')
    %div
      %button.btn.btn-outline-primary.ml-2{ type: 'button', data: { action: 'collapse-all#toggle', collapse_all_target: 'button' } }
        %i.fa.fa-compress
        Collapse All Results

  - basename = File.basename(@file_path).split('.json').first
  = render(partial: 'data_fix/phase_metadata', locals: { phase_number: 5, metadata: @phase5_meta,
                                                         extra_info: basename })

  - if @populate_stats
    .alert.alert-info.mb-3
      %strong Populated:
      = @populate_stats[:mir_created]
      individual results,
      = @populate_stats[:laps_created]
      laps
      - if @populate_stats[:relay_results_created]&.positive?
        %span.ms-2
          |
          = @populate_stats[:relay_results_created]
          relay results,
          = @populate_stats[:relay_swimmers_created]
          swimmers,
          = @populate_stats[:relay_laps_created]
          relay laps
      - if @populate_stats[:errors].any?
        %span.text-danger.ms-2
          (#{@populate_stats[:errors].size} errors)

  - if @total_programs_count.to_i.zero?
    .alert.alert-warning
      %p No results loaded from phase5 JSON yet.
      %p
        = link_to 'Populate DB Tables', review_results_path(file_path: @file_path, phase5_v2: 1, populate_db: 1), class: 'btn btn-primary'
  - else
    -# Issue Summary Banner (always shown)
    - if @issue_count.to_i.positive?
      .alert.alert-warning.d-flex.justify-content-between.align-items-center
        %div
          %i.fa.fa-exclamation-triangle.me-2
          %strong= "#{@issue_count} program(s) with issues detected"
          %span.text-muted.ms-2 (missing swimmer gender, year, or unmatched swimmers)
        %div
          - if @filter_active
            = link_to review_results_path(file_path: @file_path, phase5_v2: 1, filter_issues: '0'), class: 'btn btn-sm btn-outline-secondary' do
              %i.fa.fa-times
              Show All Programs
          - else
            = link_to review_results_path(file_path: @file_path, phase5_v2: 1, filter_issues: '1'), class: 'btn btn-sm btn-warning' do
              %i.fa.fa-filter
              Show Only Issues
    - else
      .alert.alert-success
        %i.fa.fa-check-circle.me-2
        %strong All results are valid!
        No missing swimmer data detected.

    -# Pagination and Filter Controls (similar to teams/swimmers pages)
    .card.mb-3
      .card-body.py-2
        .d-flex.justify-content-between.align-items-center
          %div
            %strong Page:
            = @current_page
            = "/"
            = @total_pages
            &nbsp;•&nbsp;
            %strong Programs:
            = @phase5_programs.size
            = "/"
            = @filter_active ? @issue_count : @total_programs_count
            - if @filter_active
              %span.badge.bg-warning.ms-2 Filtered

          -# Pagination links (first, prev, next, last)
          - if @total_pages && @total_pages > 1
            .flex-grow-1.text-center
              - pagination_base_params = request.query_parameters.except(:page)
              = link_to '«', review_results_path(pagination_base_params.merge(page: 1)),
                        class: "btn btn-sm btn-outline-primary me-1 #{'disabled' if @current_page == 1}",
                        title: 'First'
              = link_to '‹', review_results_path(pagination_base_params.merge(page: [@current_page - 1, 1].max)),
                        class: "btn btn-sm btn-outline-primary me-1 #{'disabled' if @current_page == 1}",
                        title: 'Previous'
              %span.mx-2= "#{@current_page} / #{@total_pages}"
              = link_to '›', review_results_path(pagination_base_params.merge(page: [@current_page + 1, @total_pages].min)),
                        class: "btn btn-sm btn-outline-primary me-1 #{'disabled' if @current_page == @total_pages}",
                        title: 'Next'
              = link_to '»', review_results_path(pagination_base_params.merge(page: @total_pages)),
                        class: "btn btn-sm btn-outline-primary #{'disabled' if @current_page == @total_pages}",
                        title: 'Last'

      -# Separate individual and relay programs
      - individual_programs = @phase5_programs.reject { |p| p['relay'] }
      - relay_programs = @phase5_programs.select { |p| p['relay'] }

      -# Individual Results Section
      - if individual_programs.any?
        .mb-3
          %strong Total individual programs:
          = individual_programs.size
          %span.text-muted.ml-2
            (#{individual_programs.sum { |p| p['result_count']&.to_i || 0 }} results)

        -# Responsive grid: 2 columns on large displays
        .row
          - individual_programs.each_with_index do |program, idx|
            :ruby
              # Build program_key for compatibility with partials
              program_key = "#{program['session_order']}-#{program['event_code']}-#{program['category_code']}-#{program['gender_code']}"
              # Query temp tables for this program's results
              results = GogglesDb::DataImportMeetingIndividualResult.where(
                "import_key LIKE ?", "#{program_key}/%"
              ).order(:rank)
            .col-12.col-lg-6
              = render(partial: 'data_fix/result_program_card',
                       locals: { program_key: program_key, results: results, swimmers_by_id: @swimmers_by_id,
                                 swimmers_by_key: @swimmers_by_key, teams_by_id: @teams_by_id, teams_by_key: @teams_by_key,
                                 team_key_by_swimmer_key: @team_key_by_swimmer_key,
                                 laps_by_parent_key: @laps_by_parent_key, card_index: idx })

      -# Relay Results Section
      - if relay_programs.any?
        .mt-5
          %h3.mb-3
            %i.fa.fa-users.me-2
            Relay Results

          .mb-3
            %strong Total relay programs:
            = relay_programs.size
            %span.text-muted.ml-2
              (#{relay_programs.sum { |p| p['result_count']&.to_i || 0 }} results)

          -# Responsive grid: 2 columns on large displays
          .row
            - relay_programs.each_with_index do |program, idx|
              :ruby
                # Build program_key for compatibility with partials
                program_key = "#{program['session_order']}-#{program['event_code']}-#{program['category_code']}-#{program['gender_code']}"
                # Query temp tables for this program's relay results
                relay_results = GogglesDb::DataImportMeetingRelayResult.where(
                  "import_key LIKE ?", "#{program_key}/%"
                ).order(:rank)
              .col-12.col-lg-6
                = render(partial: 'data_fix/relay_program_card',
                         locals: { program_key: program_key, relay_results: relay_results,
                                   swimmers_by_id: @swimmers_by_id, swimmers_by_key: @swimmers_by_key,
                                   teams_by_id: @teams_by_id, teams_by_key: @teams_by_key,
                                   relay_swimmers_by_parent_key: @relay_swimmers_by_parent_key,
                                   relay_laps_by_parent_key: @relay_laps_by_parent_key,
                                   relay_swimmer_names: @relay_swimmer_names,
                                   card_index: idx })
  .mb-4 &nbsp;