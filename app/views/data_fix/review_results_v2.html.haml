-# frozen_string_literal: true

= render(partial: 'data_fix_legacy/modal_progress')

.container-fluid{ data: { controller: 'collapse-all', collapse_all_selector_value: '[id^="program-panel-"]' } }
  %h2 Data-Fix V2 â€¢ Step 5: Results (Phase 5)

  .mb-2
    = render(partial: 'data_fix/step_tabs', locals: { active_step: 5, file_path: @file_path })

  .d-flex.justify-content-between.mb-2
    .mx-4.px-4 &nbsp;
    - if @all_results.present?
      %div
        = button_to commit_phase6_path(file_path: @file_path),
                                       method: :post, class: 'btn btn-success',
                                       data: { confirm: I18n.t('data_import.data_fix.btn_start_sql_batch_confirm') } do
          %i.fa.fa-database
          = I18n.t('data_import.data_fix.btn_start_sql_batch')
    %div
      %button.btn.btn-outline-primary.ml-2{ type: 'button', data: { action: 'collapse-all#toggle', collapse_all_target: 'button' } }
        %i.fa.fa-compress
        Collapse All Results

  = render(partial: 'data_fix/phase_metadata', locals: { phase_number: 5, metadata: @phase5_meta })

  - if @populate_stats
    .alert.alert-info.mb-3
      %strong Populated:
      = @populate_stats[:mir_created]
      individual results,
      = @populate_stats[:laps_created]
      laps
      - if @populate_stats[:relay_results_created]&.positive?
        %span.ms-2
          |
          = @populate_stats[:relay_results_created]
          relay results,
          = @populate_stats[:relay_swimmers_created]
          swimmers,
          = @populate_stats[:relay_laps_created]
          relay laps
      - if @populate_stats[:errors].any?
        %span.text-danger.ms-2
          (#{@populate_stats[:errors].size} errors)

  - if @all_results.blank? && @all_relay_results.blank?
    .alert.alert-warning
      %p No results loaded from database yet.
      %p
        = link_to 'Populate DB Tables', review_results_path(file_path: @file_path, phase5_v2: 1, populate_db: 1), class: 'btn btn-primary'
  
  - if @all_results.present?
    .mb-3.d-flex.justify-content-between.align-items-center
      %div
        %strong Total results in DB:
        = @all_results.size
      %small.text-muted
        Displaying up to 1000 results

    -# Group results by import_key prefix (session-event-category-gender)
    - grouped = @all_results.group_by do |mir|
      - parts = mir.import_key.split('/')
      - parts[0] # program_key: "1-200RA-M75-F"

    -# Responsive grid: 2 columns on large displays
    .row
      - grouped.keys.sort.each_with_index do |program_key, idx|
        - results = grouped[program_key]
        .col-12.col-lg-6
          = render(partial: 'data_fix/result_program_card',
                   locals: { program_key: program_key, results: results, swimmers_by_id: @swimmers_by_id,
                             teams_by_id: @teams_by_id, teams_by_key: @teams_by_key,
                             team_key_by_swimmer_key: @team_key_by_swimmer_key,
                             laps_by_parent_key: @laps_by_parent_key, card_index: idx })

  -# Relay Results Section
  - if @all_relay_results.present?
    .mt-5
      %h3.mb-3
        %i.fa.fa-users.me-2
        Relay Results

      .mb-3.d-flex.justify-content-between.align-items-center
        %div
          %strong Total relay results in DB:
          = @all_relay_results.size
        %small.text-muted
          Displaying up to 1000 results

      -# Group relay results by import_key prefix (session-event-category-gender)
      - grouped_relay = @all_relay_results.group_by do |mrr|
        - parts = mrr.import_key.split('/')
        - parts[0] # program_key: "1-4X50SL-100-119-X"

      -# Responsive grid: 2 columns on large displays
      .row
        - grouped_relay.keys.sort.each_with_index do |program_key, idx|
          - relay_results = grouped_relay[program_key]
          .col-12.col-lg-6
            = render(partial: 'data_fix/relay_program_card',
                     locals: { program_key: program_key, relay_results: relay_results,
                               swimmers_by_id: @swimmers_by_id, teams_by_id: @teams_by_id,
                               teams_by_key: @teams_by_key,
                               relay_swimmers_by_parent_key: @relay_swimmers_by_parent_key,
                               relay_laps_by_parent_key: @relay_laps_by_parent_key,
                               card_index: idx })
