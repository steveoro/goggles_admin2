-# frozen_string_literal: true

= render(partial: 'data_fix_legacy/modal_progress')

-# Phase 3 Swimmers view with collapsible cards + AutoComplete + fuzzy matching
.container-fluid
  %h2 Data-Fix V2 • Step 3: Swimmers (Phase 3)
  .mb-2
    = render(partial: 'data_fix/step_tabs', locals: { active_step: 3, file_path: @file_path })

  -# Phase Navigation buttons
  .d-flex.justify-content-between.my-2
    = link_to '< Back to file list', pull_result_files_path, class: 'btn btn-outline-secondary mr-2'
    = link_to 'Proceed to Step 4 (Events)', review_events_path(request.query_parameters), class: 'btn btn-primary'

  -# Phase Metadata card
  - basename = File.basename(@file_path).split('.json').first
  = render(partial: 'data_fix/phase_metadata', locals: { phase_number: 3, metadata: @phase3_meta,
                                                         extra_info: basename })
  - if @relay_enrichment_summary.present?
    = render(partial: 'data_fix/relay_enrichment_panel',
             locals: { summary: @relay_enrichment_summary,
                       auxiliary_files: @auxiliary_phase3_files,
                       selected_auxiliary: @selected_auxiliary_phase3_files,
                       file_path: @file_path })

  -# Search and filter controls
  .card.my-2
    .card-header
      = form_tag(review_swimmers_path, method: :get, class: 'form-inline') do
        = hidden_field_tag :file_path, @file_path
        = hidden_field_tag :phase3_v2, 1
        .form-group.mr-2
          %label.mr-1{ for: 'q' } Filter
          = text_field_tag :q, @q, class: 'form-control form-control-sm', placeholder: 'Search name...'
        .form-group.mr-2
          %label.mr-1{ for: 'swimmers_per_page' } Per page
          = select_tag :swimmers_per_page, options_for_select([50, 100, 150], @per_page), class: 'form-control form-control-sm'
        .form-group.mr-2
          .custom-control.custom-checkbox
            = check_box_tag :unmatched, '1', params[:unmatched].present?, class: 'custom-control-input', id: 'unmatched-filter'
            %label.custom-control-label{ for: 'unmatched-filter' } Show needing review
          %small.text-muted.ml-1 (unmatched + yellow/red matches)
        = submit_tag 'Apply', class: 'btn btn-sm btn-primary mr-1'
        = link_to 'Clear', review_swimmers_path(file_path: @file_path, phase3_v2: 1), class: 'btn btn-sm btn-light'
    .card-body.py-0
      -# Pagination controls (top) and Add button
      .d-flex.justify-content-between.align-items-center
        %div
          %strong Page:
          = @page
          = "/"
          = @total_pages
          &nbsp;•&nbsp;
          %strong Rows:
          = @row_range
          = "/"
          = @total_count
        .flex-grow-1.pt-3
          - if @items.present?
            = render(PageLinksForArrayComponent.new(data: @items, total_count: @total_count,
                                                    page: @page, per_page: @per_page, param_name: :swimmers_page))
        %div
          = form_tag(data_fix_add_swimmer_path, method: :post, class: 'd-inline', onsubmit: "return confirm('Add a new blank swimmer?');") do
            = hidden_field_tag :file_path, @file_path
            = hidden_field_tag :swimmers_page, params[:swimmers_page] if params[:swimmers_page].present?
            = hidden_field_tag :swimmers_per_page, params[:swimmers_per_page] if params[:swimmers_per_page].present?
            = hidden_field_tag :q, params[:q] if params[:q].present?
            = hidden_field_tag :unmatched, params[:unmatched] if params[:unmatched].present?
            %button.btn.btn-sm.btn-success{ type: 'submit' }
              %i.fa.fa-plus
              Add Swimmer

  -# Swimmers as collapsible cards
  - if @items.empty?
    .alert.alert-info
      %em No swimmers found. Adjust filters or rescan to rebuild phase3 file.
  - else
    - @items.each_with_index do |swimmer_hash, idx|
      :ruby
        swimmer_key = swimmer_hash['key']
        swimmer_index = ((@page - 1) * @per_page) + idx
        swimmer_id = swimmer_hash['swimmer_id']
        has_match = swimmer_id.to_i.positive?
        gender_guessed = swimmer_hash['gender_guessed'] == true
        
        # Check for required data
        first_name = swimmer_hash['first_name']
        last_name = swimmer_hash['last_name']
        year_of_birth = swimmer_hash['year_of_birth']
        gender_type_code = swimmer_hash['gender_type_code']
        
        # Missing data flags
        missing_name = first_name.blank? && last_name.blank?
        missing_yob = year_of_birth.to_i.zero?
        missing_gender = gender_type_code.blank?
        has_missing_data = missing_name || missing_yob || missing_gender
        
        # Special case: has ID but missing first/last name (needs optional editing)
        needs_optional_edit = has_match && (first_name.blank? || last_name.blank?)
        
        # Determine visual styling
        if has_match && !needs_optional_edit
          # Matched with complete data
          card_bg = 'bg-light'
          border_color = 'border-secondary'
          icon_class = 'fa-check-circle text-success'
          icon_title = 'Matched'
        elsif needs_optional_edit
          # Has ID but needs optional editing
          card_bg = 'bg-light-yellow'
          border_color = 'border-warning'
          icon_class = 'fa-edit text-primary'
          icon_title = 'Needs optional editing'
        elsif !has_match && has_missing_data
          # New swimmer with missing required data
          card_bg = 'bg-light-red'
          border_color = 'border-danger'
          icon_class = 'fa-exclamation-triangle text-danger'
          icon_title = 'Missing required data'
        else
          # New swimmer with all required data
          card_bg = 'bg-light-yellow'
          border_color = 'border-warning'
          icon_class = 'fa-plus-circle text-warning'
          icon_title = 'New/Unmatched'
        end
        border_width = 'border-2'

      = render(partial: 'swimmer_form_card',
               locals: { file_path: @file_path, api_url: @api_url, swimmer_hash:, swimmer_index:,
                         swimmer_key:, swimmer_id:, has_match:, has_missing_data:, needs_optional_edit:,
                         missing_name:, missing_yob:, missing_gender:, gender_guessed:,
                         card_bg:, border_color:, border_width:, icon_class:, icon_title: })

  -# Pagination controls (bottom)
  .mt-3
    - if @items.present?
      = render(PageLinksForArrayComponent.new(data: @items, total_count: @total_count,
                                              page: @page, per_page: @per_page, param_name: :swimmers_page))
