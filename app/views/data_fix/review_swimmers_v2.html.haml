-# frozen_string_literal: true

-# Phase 3 Swimmers view with collapsible cards + AutoComplete + fuzzy matching

.container-fluid
  %h2 Data-Fix V2 • Step 3: Swimmers (Phase 3)

  .mb-2
    = render(partial: 'data_fix/step_tabs', locals: { active_step: 3, file_path: @file_path })

  -# Phase Metadata card
  .card.mb-3
    .card-header Phase Metadata
    .card-body
      - if @phase3_meta
        %dl.row.mb-0
          %dt.col-sm-4 Generated at:
          %dd.col-sm-8= @phase3_meta['generated_at']
          %dt.col-sm-4 Generator:
          %dd.col-sm-8= @phase3_meta['generator']
          %dt.col-sm-4 Source:
          %dd.col-sm-8
            %small= @phase3_meta['source_path']

  -# Phase Navigation buttons
  .d-flex.justify-content-between.mb-2
    %div
      = link_to 'Use legacy (Step 3)', review_swimmers_path(request.query_parameters.except(:phase3_v2)), class: 'btn btn-secondary btn-block'
    -# This is a duplicate of the tab rescan button, so commented out for now
    -# %div
    -#   = link_to review_swimmers_path(request.query_parameters.merge(phase3_v2: 1, rescan: 1)), class: 'btn btn-warning btn-block', data: { confirm: 'Rescan will rebuild phase3 file. Continue?' }, method: :get do
    -#     %i.fa.fa-sync
    -#     Rescan Swimmers
    %div
      = link_to 'Proceed to Step 4 (Events)', review_events_path(request.query_parameters), class: 'btn btn-primary btn-block'

  -# Search and filter controls
  .card.mb-3
    .card-body
      = form_tag(review_swimmers_path, method: :get, class: 'form-inline') do
        = hidden_field_tag :file_path, @file_path
        = hidden_field_tag :phase3_v2, 1
        .form-group.mr-2
          %label.mr-1{ for: 'q' } Filter
          = text_field_tag :q, @q, class: 'form-control form-control-sm', placeholder: 'Search name...'
        .form-group.mr-2
          %label.mr-1{ for: 'per_page' } Per page
          = select_tag :per_page, options_for_select([50, 100, 150], @per_page), class: 'form-control form-control-sm'
        = submit_tag 'Apply', class: 'btn btn-sm btn-primary mr-1'
        = link_to 'Clear', review_swimmers_path(file_path: @file_path, phase3_v2: 1), class: 'btn btn-sm btn-light'

  -# Pagination info and Add button
  .d-flex.justify-content-between.align-items-center.mb-2
    %div
      %strong Page:
      = @page
      = "/"
      = @total_pages
      &nbsp;•&nbsp;
      %strong Rows:
      = @row_range
      = "/"
      = @total_count
    %div
      = link_to data_fix_add_swimmer_path(file_path: @file_path), method: :post, class: 'btn btn-sm btn-success', data: { confirm: 'Add a new blank swimmer?' } do
        %i.fa.fa-plus
        Add Swimmer

  -# Swimmers as collapsible cards
  - if @items.empty?
    .alert.alert-info
      %em No swimmers found. Adjust filters or rescan to rebuild phase3 file.
  - else
    - @items.each_with_index do |swimmer, idx|
      - swimmer_index = ((@page - 1) * @per_page) + idx
      - swimmer_id = swimmer['swimmer_id']
      - has_match = swimmer_id.present?
      - card_bg = has_match ? 'bg-light' : 'bg-light-yellow'
      - border_color = has_match ? 'border-secondary' : 'border-warning'
      - border_width = 'border-2'
      
      .card.mb-2{ class: "#{card_bg} #{border_color} #{border_width}", id: "swimmer-card-#{swimmer_index}" }
        .card-header.d-flex.justify-content-between.align-items-center{ id: "swimmer-header-#{swimmer_index}", style: 'cursor: pointer;', data: { toggle: 'collapse', target: "#swimmer-panel-#{swimmer_index}" } }
          .d-flex.align-items-center
            %span.mr-2
              - if has_match
                %i.fa.fa-check-circle.text-success{ title: 'Matched' }
              - else
                %i.fa.fa-plus-circle.text-warning{ title: 'New/Unmatched' }
            %strong
              = swimmer['complete_name']
            %small.ml-2.text-muted
              (#{swimmer['year_of_birth']}, #{swimmer['gender_type_code']})
            - if has_match
              %small.ml-2.badge.badge-success
                ID: #{swimmer_id}
            - else
              %small.ml-2.badge.badge-primary
                NEW
          .d-flex.align-items-center
            = link_to data_fix_delete_swimmer_path(file_path: @file_path, swimmer_index: swimmer_index), method: :delete, class: 'btn btn-sm btn-danger', data: { confirm: "Delete swimmer #{swimmer['complete_name']}?" }, onclick: 'event.stopPropagation();' do
              %i.fa.fa-trash
        
        .collapse{ id: "swimmer-panel-#{swimmer_index}", 'aria-labelledby' => "swimmer-header-#{swimmer_index}", 'data-parent' => "#swimmer-card-#{swimmer_index}" }
          .card-body.border-bottom.border-secondary
            = form_tag(update_phase3_swimmer_path, method: :patch) do
              = hidden_field_tag :file_path, @file_path
              = hidden_field_tag :swimmer_index, swimmer_index
              
              .container-fluid
                -# Row 0: Fuzzy matches dropdown (quick selection)
                - fuzzy_matches = swimmer['fuzzy_matches'] || []
                - if fuzzy_matches.present?
                  .row
                    .col-12
                      .form-group
                        = label_tag "fuzzy_select_#{swimmer_index}", 'Quick match selection (fuzzy matches)'
                        = select_tag "fuzzy_select_#{swimmer_index}", options_for_select([['-- Select a match --', '']] + fuzzy_matches.map { |m| [m['display_label'], m['id']] }, swimmer_id), class: 'form-control', id: "fuzzy_select_#{swimmer_index}", onchange: "var swimmerId = this.value; if (swimmerId) { $('#swimmer_#{swimmer_index}_swimmer_id').val(swimmerId).trigger('change'); }"
                        %small.form-text.text-muted
                          Select a match from the list to quickly populate swimmer fields via AutoComplete.
                
                -# Row 1: Swimmer AutoComplete + complete_name
                .row
                  .col-6
                    = render(AutoCompleteComponent.new(show_top_labels: true, base_dom_id: "swimmer[#{swimmer_index}]", base_api_url: @api_url, detail_endpoint: 'swimmer', base_name: 'swimmer', label_column: 'complete_name', default_value: swimmer_id, search_endpoint: 'swimmers', search_column: 'complete_name', target3_dom_id: "swimmer_#{swimmer_index}_complete_name", target3_column: 'complete_name', target4_dom_id: "swimmer_#{swimmer_index}_year_of_birth", target4_column: 'year_of_birth', target5_dom_id: "swimmer_#{swimmer_index}_gender_type_code", target5_column: 'gender_type_code'))
                  .col-6
                    .form-group
                      %label Complete Name
                      = text_field_tag "swimmer[complete_name]", swimmer['complete_name'], class: 'form-control', id: "swimmer_#{swimmer_index}_complete_name"
                
                -# Row 2: Year of Birth + Gender
                .row
                  .col-6
                    .form-group
                      %label Year of Birth
                      = number_field_tag "swimmer[year_of_birth]", swimmer['year_of_birth'], class: 'form-control', id: "swimmer_#{swimmer_index}_year_of_birth"
                  .col-6
                    .form-group
                      %label Gender Type Code
                      = select_tag "swimmer[gender_type_code]", options_for_select([['M', 'M'], ['F', 'F']], swimmer['gender_type_code']), include_blank: true, class: 'form-control', id: "swimmer_#{swimmer_index}_gender_type_code"
                
                -# Row 3: First Name + Last Name
                .row
                  .col-6
                    .form-group
                      %label First Name
                      = text_field_tag "swimmer[first_name]", swimmer['first_name'], class: 'form-control'
                  .col-6
                    .form-group
                      %label Last Name
                      = text_field_tag "swimmer[last_name]", swimmer['last_name'], class: 'form-control'
                
                -# Submit button
                .row
                  .col-12
                    = submit_tag 'Save Swimmer', class: 'btn btn-primary'

  -# Pagination controls (bottom)
  .d-flex.justify-content-between.align-items-center.mt-3
    %div
      - prev_page = @page > 1 ? @page - 1 : nil
      - if prev_page
        = link_to 'Prev', review_swimmers_path(request.query_parameters.merge(phase3_v2: 1, per_page: @per_page, page: prev_page)), class: 'btn btn-sm btn-outline-secondary'
    %div
      %strong Page:
      = @page
      = "/"
      = @total_pages
      &nbsp;•&nbsp;
      %strong Rows:
      = @row_range
      = "/"
      = @total_count
    %div
      - next_page = (@page * @per_page) < @total_count ? @page + 1 : nil
      - if next_page
        = link_to 'Next', review_swimmers_path(request.query_parameters.merge(phase3_v2: 1, per_page: @per_page, page: next_page)), class: 'btn btn-sm btn-outline-secondary'
