# Data Review & Linking

After a source file (PDF or web crawl) has been processed into the standardized JSON format (`pdf_processing.md`), the next crucial step is to link the data within that JSON file to the actual entities in the Goggles database and allow administrators to review and correct this linking before final commitment. This involves the `Import::MacroSolver` and the `DataFixController`.

## 1. Data Linking (`Import::MacroSolver`)

The `Import::MacroSolver` class (`app/strategies/import/macro_solver.rb`) is responsible for the automated process of bridging the gap between the parsed data in the JSON file and the structured database records.

*   **Input:** The standardized JSON data hash for a specific meeting/result set, previously generated by the PDF processing pipeline.
*   **Process:**
    1.  **Iteration:** The solver traverses the JSON data hash, identifying conceptual entities like Meetings, Sessions, Events, Categories, Swimmers, Teams, Individual Results, Relay Results, Laps, etc.
    2.  **Database Lookup:** For each item, it queries the **local** `goggles_db` database using specialized Finder classes (e.g., `Finders::SwimmerFinder`, `Finders::TeamFinder`) to find existing matching records based on names, codes, dates, and other identifying attributes.
    3.  **Local Record Creation:** If no suitable existing record is found in the local database, the `MacroSolver` **creates a new record** for that entity locally. For example, if a swimmer mentioned in the results doesn't exist in the database, a new `Swimmer` record is created.
    4.  **JSON Enrichment:** The solver then updates the JSON data hash by adding database `id`s and unique reference `key`s for every entity it processed (whether found or newly created). It stores these under specific keys within the hash (e.g., `data['swimmer'][swimmer_key] = { id: swimmer_id, ... }`). It also adds `bindings` to link related entities (e.g., linking a result row to its corresponding swimmer and event keys).
    5.  **Ambiguity Resolution:** It attempts to resolve inconsistencies or missing data points within the JSON file, such as inferring a missing team name for a swimmer based on other entries.
*   **Output:** The **enriched JSON data hash**. This hash now contains not only the original parsed data but also direct references to the corresponding records in the *local* database. This enriched JSON file is saved (overwriting the previous version) and becomes the basis for the manual review step.

**Important Note:** The `MacroSolver` directly modifies the *local* database by creating new records during this phase.

## 2. Manual Data Review & Correction (`DataFixController`)

The `DataFixController` (`app/controllers/data_fix_controller.rb`) provides the user interface for administrators to review the data processed and linked by the `MacroSolver`.

*   **Input:** The enriched JSON file generated by `MacroSolver`.
*   **Interface:** Offers several distinct review pages, accessible via actions like:
    *   `/data_fix/review_sessions`: Verify Meeting and Session details.
    *   `/data_fix/review_teams`: Check linked Teams.
    *   `/data_fix/review_swimmers`: Check linked Swimmers.
    *   `/data_fix/review_events`: Verify Events, Categories, and Gender programs.
    *   `/data_fix/review_results`: Examine individual/relay results, times, and ranks.
*   **Process:**
    1.  The controller loads the enriched JSON file and uses the embedded database links (`id`s and `key`s added by `MacroSolver`) to display the parsed data alongside the database records it has been matched with.
    2.  Administrators can review these matches and the parsed data for accuracy.
    3.  If errors or incorrect links are found, the administrator can make corrections through the UI (e.g., re-linking a result to a different swimmer, correcting a typo in a team name, adjusting a time, adding a missing session).
    4.  These corrections are submitted to the `DataFixController#update` action (or other specific actions like `purge`, `add_session`).
    5.  The controller updates the data **in memory** within the loaded `MacroSolver` instance.
*   **Output:** The controller **saves the modified data back to the JSON file**, overwriting it with the corrected information and links. This ensures that all manual adjustments are persisted within the JSON file itself, ready for the final commit stage.

This review cycle allows for human oversight and correction, improving data quality before the final import into the database.
