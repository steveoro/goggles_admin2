# PDF Result Processing

A significant challenge in aggregating swimming results is handling the variety of formats used in PDF reports published by different organizations. `goggles_admin2` employs a multi-step process to convert these PDFs into a standardized JSON format suitable for further processing and data linking.

## 1. PDF to Text Conversion

*   **Trigger:** This step usually follows the download of a `.pdf` result file by the external crawler. While not explicitly shown as automated, the `PdfController#extract_txt` action performs the conversion.
*   **Tool:** It relies on the external command-line utility `pdftotext` (part of the Poppler suite). This utility must be installed on the server where `goggles_admin2` runs.
*   **Process:** `pdftotext -layout <input.pdf> <output.txt>` is executed to convert the PDF into a text file while attempting to preserve the original layout structure.
*   **Output:** A `.txt` file corresponding to the input PDF, typically saved in the same directory (e.g., `crawler/data/results.new/<season_id>/meeting_<id>.txt`).

## 2. Text Parsing and Format Recognition

*   **Trigger:** The `PdfController#scan` and `PdfController#log_contents` actions initiate the parsing of the generated `.txt` file.
*   **Core Component:** The `PdfResults::FormatParser` class (`app/strategies/pdf_results/format_parser.rb`) is the heart of this process.
*   **Format Definitions:** The parser uses a collection of YAML files located in `app/strategies/pdf_results/formats/`. Each YAML file defines a specific known layout (or a family of related layouts) using regular expressions and contextual rules to identify key data points like:
    *   Meeting headers
    *   Event details (stroke, distance, gender, category)
    *   Individual results (rank, swimmer name, year, team, time, splits)
    *   Relay results
    *   Team rankings
*   **Process:**
    1.  The `FormatParser` reads the `.txt` file page by page.
    2.  It compares the text content against the definitions in the various format YAML files.
    3.  It identifies which format(s) best match the structure of the text on each page. A single PDF/TXT file can contain multiple different formats across its pages.

## 3. Data Extraction and Standardization

*   **Intermediate Conversion:** As different formats are recognized, the extracted data is converted into a common intermediate structure, likely involving classes like `PdfResults::L2Converter` and `PdfResults::L2EventSection`. This allows consistent handling regardless of the original PDF layout.
*   **Data Aggregation:** The parser aggregates the data extracted from all pages according to the recognized formats.
*   **Cleanup:** Basic data cleanup might occur (e.g., attempting to fill missing team names, as seen in `PdfController`).
*   **Output:** The final result of this stage is a Ruby Hash containing the structured meeting results data.

## 4. JSON Serialization

*   **Trigger:** The `PdfController#log_contents` action saves the processed data.
*   **Process:** The final Ruby Hash generated by the parser is serialized into a **standardized JSON file**.
*   **Output:** A `.json` file (e.g., `crawler/data/results.json/meeting_<id>.json`) containing the structured results, ready for the next stage: data review and linking to database entities via `Import::MacroSolver`.

This process ensures that despite the diverse and often inconsistent formatting of source PDFs, the results data is transformed into a predictable structure for reliable import into the Goggles database.
